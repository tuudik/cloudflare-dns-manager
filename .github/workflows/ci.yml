name: Lint and Test

on:
  push:
    branches: ["*"]
  pull_request:
    branches: ["*"]

permissions:
  contents: read

concurrency:
  group: lint-and-test-global
  cancel-in-progress: false

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.13"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt

      - name: Lint with flake8
        id: flake8
        run: |
          # Stop on syntax errors or undefined names
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          # Fail on style/complexity issues too
          flake8 . --count --max-complexity=10 --max-line-length=127 --statistics

      - name: Auto-format with black
        id: black_autofmt
        if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository)
        run: black dns-manager.py test_dns_manager.py

      - name: Commit Black formatting changes
        id: black_commit
        if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository)
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "style: auto-format with black (run ${{ github.run_id }}, sha ${{ github.sha }})"
          file_pattern: dns-manager.py test_dns_manager.py

      - name: Format check with black (read-only contexts)
        id: black_check
        if: github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name != github.repository
        run: black --check --diff dns-manager.py test_dns_manager.py

      - name: Write lint summary
        if: always()
        env:
          FLAKE8_OUTCOME: ${{ steps.flake8.outcome }}
          BLACK_AUTOFMT_OUTCOME: ${{ steps.black_autofmt.outcome }}
          BLACK_COMMIT_OUTCOME: ${{ steps.black_commit.outcome }}
          BLACK_CHECK_OUTCOME: ${{ steps.black_check.outcome }}
          BLACK_CHANGES_DETECTED: ${{ steps.black_commit.outputs.changes_detected }}
        run: |
          python - << 'PY'
          import os

          summary = os.environ.get("GITHUB_STEP_SUMMARY")
          if not summary:
              raise SystemExit("GITHUB_STEP_SUMMARY not set")

          def value(name: str) -> str:
              return os.environ.get(name) or "not-run"

          flake8_outcome = value("FLAKE8_OUTCOME")
          black_autofmt_outcome = value("BLACK_AUTOFMT_OUTCOME")
          black_commit_outcome = value("BLACK_COMMIT_OUTCOME")
          black_check_outcome = value("BLACK_CHECK_OUTCOME")
          black_changes = value("BLACK_CHANGES_DETECTED")

          lines = [
              "## Lint Summary",
              "",
              f"- flake8: {flake8_outcome}",
          ]

          if black_autofmt_outcome != "not-run":
              lines.append(f"- black auto-format: {black_autofmt_outcome}")
              lines.append(f"- black auto-commit: {black_commit_outcome}")
              if black_commit_outcome != "not-run":
                  lines.append(f"- formatting changes committed: {black_changes}")

          if black_check_outcome != "not-run":
              lines.append(f"- black check: {black_check_outcome}")

          with open(summary, "a", encoding="utf-8") as handle:
              handle.write("\n".join(lines) + "\n")
          PY

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: lint
    concurrency:
      group: cloudflare-integration-tests
      cancel-in-progress: false
    permissions:
      contents: read

    # Only run tests if Cloudflare credentials are available
    # (They won't be available for PRs from forks for security)
    if: github.event_name == 'push' || github.event.pull_request.head.repo.full_name == github.repository

    steps:
      - uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.13"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov

      - name: Create test config
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN_TEST }}
          CLOUDFLARE_ZONE_ID: ${{ secrets.CLOUDFLARE_ZONE_ID_TEST }}
          CF_ZONE_NAME: ${{ secrets.CF_ZONE_NAME_TEST || 'test.example.com' }}
        run: |
          mkdir -p .secrets
          printf "%s" "${CLOUDFLARE_API_TOKEN}" > .secrets/cf_api_token
          cat > config.yaml << EOF
          global:
            domain: "${CF_ZONE_NAME}"
            zone_id: "${CLOUDFLARE_ZONE_ID}"
            api_token: "${CLOUDFLARE_API_TOKEN}"
            default_ip: "192.168.1.100"
            docker_discovery: true
            docker_defaults:
              proxied: false
              ttl: 1
              type: "A"

          domains:
            ${CF_ZONE_NAME}:
              zone_id: "${CLOUDFLARE_ZONE_ID}"
              api_token: "${CLOUDFLARE_API_TOKEN}"

          manual_records: []
          EOF

      - name: Run tests with pytest
        env:
          CF_API_TOKEN_FILE: .secrets/cf_api_token
          CF_ZONE_NAME: "${{ secrets.CF_ZONE_NAME_TEST || 'test.example.com' }}"
          CF_ZONE_ID: ${{ secrets.CLOUDFLARE_ZONE_ID_TEST }}
          REQUIRE_CF_TESTS: true
          CF_MANAGED_COMMENT: "github-actions:${{ github.run_id }}"
        run: |
          pytest test_dns_manager.py -v --cov=. --cov-branch --cov-report=xml --cov-report=term --junitxml=pytest-report.xml

      - name: Write test summary
        if: always()
        run: |
          python - << 'PY'
          import os
          import xml.etree.ElementTree as ET

          summary = os.environ.get("GITHUB_STEP_SUMMARY")
          if not summary:
              raise SystemExit("GITHUB_STEP_SUMMARY not set")

          def format_list(items, limit=20):
              if not items:
                  return "- none"
              shown = items[:limit]
              suffix = "" if len(items) <= limit else f" (and {len(items) - limit} more)"
              return "- " + ", ".join(shown) + suffix

          lines = ["## Test Summary", "", "- Test suite: `pytest test_dns_manager.py`"]

          junit_path = "pytest-report.xml"
          if os.path.exists(junit_path):
              tree = ET.parse(junit_path)
              root = tree.getroot()
              passed, failed, skipped = [], [], []
              for case in root.findall(".//testcase"):
                  name = f"{case.get('classname')}::{case.get('name')}"
                  if case.find("failure") is not None or case.find("error") is not None:
                      failed.append(name)
                  elif case.find("skipped") is not None:
                      skipped.append(name)
                  else:
                      passed.append(name)
              lines.append(f"- Passed tests ({len(passed)}):")
              lines.append(format_list(passed))
              lines.append(f"- Failed tests ({len(failed)}):")
              lines.append(format_list(failed))
              if skipped:
                  lines.append(f"- Skipped tests ({len(skipped)}):")
                  lines.append(format_list(skipped))
          else:
              lines.append("- Test details: not available (pytest-report.xml missing)")

          coverage_path = "coverage.xml"
          if os.path.exists(coverage_path):
              tree = ET.parse(coverage_path)
              root = tree.getroot()
              line_rate = float(root.attrib.get("line-rate", 0)) * 100
              branch_rate = float(root.attrib.get("branch-rate", 0)) * 100
              lines.append(f"- Coverage (lines): {line_rate:.1f}%")
              lines.append(f"- Coverage (branches): {branch_rate:.1f}%")
          else:
              lines.append("- Coverage: not available (coverage.xml missing)")

          with open(summary, "a", encoding="utf-8") as handle:
              handle.write("\n".join(lines) + "\n")
          PY

      - name: Upload coverage report
        uses: actions/upload-artifact@v7
        with:
          name: coverage-xml
          path: ./coverage.xml
          if-no-files-found: warn

  docker-test-build:
    name: Test Docker Build
    runs-on: ubuntu-latest
    needs: [lint, test]
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Extract Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            name=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          flavor: |
            latest=false
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix=sha-

      - name: Build Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: false
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
